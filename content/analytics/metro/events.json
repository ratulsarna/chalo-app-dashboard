{
  "flowId": "metro",
  "flowName": "Metro Ticket Booking",
  "description": "Complete analytics map for the metro ticket booking journey including route discovery, fare fetching, booking, payment, and QR validation. Includes ONDC metro tickets.",
  "propertyDefinitions": {
    "stop id": {
      "type": "string",
      "description": "Unique identifier for a metro station/stop."
    },
    "stop name": {
      "type": "string",
      "description": "Display name of the metro station/stop."
    },
    "stop type": {
      "type": "string",
      "description": "Type of stop selection - FROM or TO.",
      "values": ["FROM", "TO"]
    },
    "from stop id": {
      "type": "string",
      "description": "Unique identifier for the origin metro station."
    },
    "from stop name": {
      "type": "string",
      "description": "Display name of the origin metro station."
    },
    "to stop id": {
      "type": "string",
      "description": "Unique identifier for the destination metro station."
    },
    "to stop name": {
      "type": "string",
      "description": "Display name of the destination metro station."
    },
    "isActive": {
      "type": "string",
      "description": "Whether the metro config is active (boolean as string)."
    },
    "configId": {
      "type": "string",
      "description": "Metro configuration identifier."
    },
    "count": {
      "type": "string",
      "description": "Count of items (stations list size or fare options count)."
    },
    "error": {
      "type": "string",
      "description": "Error message when API calls fail."
    },
    "bookingMode": {
      "type": "string",
      "description": "The mode of booking (e.g., regular, return trip)."
    },
    "passengerTypes": {
      "type": "string",
      "description": "JSON representation of passenger types selected for booking."
    },
    "tripDetails": {
      "type": "string",
      "description": "JSON representation of trip details including from/to stations."
    },
    "fare": {
      "type": "string",
      "description": "Fare amount for the metro ticket."
    },
    "orderId": {
      "type": "string",
      "description": "Backend order identifier returned after order creation."
    },
    "transaction id": {
      "type": "string",
      "description": "Transaction identifier from the payment system."
    },
    "bookingId": {
      "type": "string",
      "description": "Unique identifier for the booked metro ticket."
    },
    "route name": {
      "type": "string",
      "description": "Name of the metro route/line."
    },
    "pickupStopName": {
      "type": "string",
      "description": "Name of the boarding station."
    },
    "dropStopName": {
      "type": "string",
      "description": "Name of the alighting station."
    },
    "ticketStatus": {
      "type": "string",
      "description": "Status of the metro ticket (e.g., BOOKED, ACTIVE, USED)."
    },
    "passengerCount": {
      "type": "string",
      "description": "Total number of passengers on the ticket."
    },
    "refundInfoStatus": {
      "type": "string",
      "description": "Refund eligibility status for the ticket."
    },
    "refundInfoMessage": {
      "type": "string",
      "description": "Message describing refund terms."
    },
    "fullName": {
      "type": "string",
      "description": "Full name of the ticket holder."
    },
    "time": {
      "type": "string",
      "description": "Formatted time string from true time."
    },
    "date": {
      "type": "string",
      "description": "Formatted date string from true time."
    },
    "productType": {
      "type": "string",
      "description": "Product type identifier."
    },
    "productSubType": {
      "type": "string",
      "description": "Product sub-type identifier."
    },
    "activationTime": {
      "type": "number",
      "description": "Epoch milliseconds when the ticket was activated."
    },
    "isOndcTicketOrder": {
      "type": "boolean",
      "description": "True when the validated ticket/order is an ONDC ticket."
    },
    "totalResults": {
      "type": "number",
      "description": "Total results count returned by a route search."
    },
    "flowType": {
      "type": "string",
      "description": "Flow variant identifier (e.g., ondc)."
    },
    "transactionId": {
      "type": "string",
      "description": "Checkout transaction id (distinct from \"transaction id\")."
    },
    "bookingDate": {
      "type": "string",
      "description": "Booking date string passed into checkout analytics."
    },
    "amount": {
      "type": "string",
      "description": "Payment amount (typically stringified number)."
    },
    "paymentId": {
      "type": "string",
      "description": "Payment provider payment id."
    },
    "hourOfEvent": {
      "type": "string",
      "description": "Hour-of-day value for the payment event (stringified)."
    },
    "agency": {
      "type": "string",
      "description": "Agency name added by checkout analytics."
    },
    "reason": {
      "type": "string",
      "description": "Failure reason string."
    },
    "invalidResponse": {
      "type": "boolean",
      "description": "True when the response payload is considered invalid."
    },
    "type": {
      "type": "string",
      "description": "Type discriminator (e.g., problem type or exception class)."
    },
    "problemSource": {
      "type": "string",
      "description": "Source screen where problem was reported.",
      "values": ["VALIDATION_SCREEN"]
    }
  },
  "stages": [
    {
      "name": "Landing & Discovery",
      "description": "Metro landing flows - station/line selection, config fetching, and fare/route discovery.",
      "events": [
        "stop based metro landing screen opened",
        "from station clicked",
        "to station clicked",
        "metro stop selected",
        "swap button clicked",
        "recent stop based trip clicked",
        "metro config fetch success",
        "metro config fetch failed",
        "metro all stations fetch success",
        "metro all stations fetch failed",
        "metro fare fetch success",
        "metro fare fetch failed",
        "ticket fare fetch failure",
        "booking mode search button clicked",
        "booking mode proceed button clicked"
      ]
    },
    {
      "name": "ONDC Route Search",
      "description": "ONDC metro route search result events.",
      "events": [
        "stop based stop selection screen route result success",
        "stop based stop selection screen route result failure"
      ]
    },
    {
      "name": "Confirm Booking",
      "description": "Booking confirmation screen - final fare calculation and order creation.",
      "events": [
        "confirm screen opened",
        "confirm final fare fetch success",
        "confirm final fare fetch failed",
        "pay button clicked",
        "order api success",
        "order api failure",
        "retry button clicked"
      ]
    },
    {
      "name": "Payment",
      "description": "Checkout payment result events for metro tickets (emitted by the checkout module).",
      "events": [
        "metro ticket payment successful",
        "metro ticket payment failed",
        "ondc metro ticket payment successful",
        "ondc metro ticket payment failed"
      ]
    },
    {
      "name": "Booking Success",
      "description": "Post-payment confirmation screen.",
      "events": [
        "metro booking confirmed",
        "ondc metro booking confirmed"
      ]
    },
    {
      "name": "Ticket Fetch",
      "description": "Ticket data fetching for validation.",
      "events": [
        "metro ticket fetched",
        "ondc metro ticket fetched"
      ]
    },
    {
      "name": "QR Validation",
      "description": "Static QR validation interactions for metro tickets.",
      "events": [
        "simple qr validation zoom qr clicked"
      ]
    },
    {
      "name": "Global",
      "description": "Validation utility events shared across products.",
      "events": [
        "view trip receipt from menu clicked",
        "report problem clicked v2"
      ]
    }
  ],
  "events": [
    {
      "name": "stop based stop selection screen route result success",
      "component": "MetroLandingScreenComponent",
      "stage": "ONDC Route Search",
      "source": "Source.STOP_BASED_ROUTE_SELECTION_FRAGMENT",
      "description": "ONDC route search returned 0 routes (no routes available).",
      "properties": [
        { "property": "totalResults" },
        { "property": "flowType", "context": "ondc" }
      ]
    },
    {
      "name": "stop based stop selection screen route result failure",
      "component": "MetroLandingScreenComponent",
      "stage": "ONDC Route Search",
      "source": "Source.STOP_BASED_ROUTE_SELECTION_FRAGMENT",
      "description": "ONDC route search failed due to network/server/parse/local error.",
      "properties": [
        { "property": "flowType", "context": "ondc" }
      ]
    },
    {
      "name": "ticket fare fetch failure",
      "component": "FetchTicketBookingsFareUseCase",
      "stage": "Landing & Discovery",
      "source": "Source.FARE_DETAILS_FETCH_USECASE",
      "description": "Unexpected exception while fetching ticket fare details.",
      "properties": [
        { "property": "type" },
        { "property": "reason" },
        { "property": "invalidResponse" }
      ]
    },
    {
      "name": "stop based metro landing screen opened",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "Raised when the metro landing screen is opened.",
      "properties": []
    },
    {
      "name": "from station clicked",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User tapped the from/origin station selector.",
      "properties": []
    },
    {
      "name": "to station clicked",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User tapped the to/destination station selector.",
      "properties": []
    },
    {
      "name": "metro stop selected",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User selected a metro station from the picker.",
      "properties": [
        { "property": "stop id" },
        { "property": "stop name" },
        { "property": "stop type", "context": "FROM or TO indicating which station was selected" }
      ]
    },
    {
      "name": "swap button clicked",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User tapped the swap button to interchange from/to stations.",
      "properties": [
        { "property": "from stop name" },
        { "property": "to stop name" }
      ]
    },
    {
      "name": "recent stop based trip clicked",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User tapped a recent trip pair to auto-fill stations.",
      "properties": [
        { "property": "from stop id" },
        { "property": "from stop name" },
        { "property": "to stop id" },
        { "property": "to stop name" }
      ]
    },
    {
      "name": "metro config fetch success",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "Metro configuration was successfully fetched.",
      "properties": [
        { "property": "isActive", "context": "Boolean as string indicating if config is active" },
        { "property": "configId" }
      ]
    },
    {
      "name": "metro config fetch failed",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "Metro configuration fetch failed.",
      "properties": [
        { "property": "error" }
      ]
    },
    {
      "name": "metro all stations fetch success",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "All metro stations list was successfully fetched.",
      "properties": [
        { "property": "count", "context": "Number of stations returned" }
      ]
    },
    {
      "name": "metro all stations fetch failed",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "Failed to fetch metro stations list.",
      "properties": [
        { "property": "error" }
      ]
    },
    {
      "name": "metro fare fetch success",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "Fare details were successfully fetched for the selected route.",
      "properties": [
        { "property": "count", "context": "Number of fare options available" }
      ]
    },
    {
      "name": "metro fare fetch failed",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "Failed to fetch fare details.",
      "properties": [
        { "property": "error" }
      ]
    },
    {
      "name": "booking mode search button clicked",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User clicked the search button to fetch fare details.",
      "properties": []
    },
    {
      "name": "booking mode proceed button clicked",
      "component": "StopBasedMetroLandingScreenComponent",
      "stage": "Landing & Discovery",
      "source": "Source.STOP_BASED_METRO_LANDING_SCREEN",
      "description": "User clicked proceed to navigate to the confirm booking screen.",
      "properties": []
    },
    {
      "name": "confirm screen opened",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "Booking confirmation screen was opened.",
      "properties": [
        { "property": "bookingMode" },
        { "property": "passengerTypes", "context": "JSON string of passenger type counts" },
        { "property": "tripDetails", "context": "JSON string with from/to station details" }
      ]
    },
    {
      "name": "confirm final fare fetch success",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "Final fare was successfully calculated.",
      "properties": [
        { "property": "fare" }
      ]
    },
    {
      "name": "confirm final fare fetch failed",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "Failed to calculate final fare.",
      "properties": [
        { "property": "error" }
      ]
    },
    {
      "name": "pay button clicked",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "User clicked the pay button to proceed to payment.",
      "properties": [
        { "property": "fare" }
      ]
    },
    {
      "name": "order api success",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "Metro ticket order was successfully created.",
      "properties": [
        { "property": "orderId" },
        { "property": "transaction id" }
      ]
    },
    {
      "name": "order api failure",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "Failed to create metro ticket order.",
      "properties": [
        { "property": "error" }
      ]
    },
    {
      "name": "retry button clicked",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Confirm Booking",
      "source": "Source.CONFIRM_BOOKING_SCREEN",
      "description": "User clicked retry button after fare fetch failure.",
      "properties": []
    },
    {
      "name": "metro ticket payment successful",
      "component": "CheckoutComponent",
      "stage": "Payment",
      "source": "Source.CHECKOUT_ACTIVITY",
      "description": "Metro ticket payment completed successfully.",
      "properties": [
        { "property": "transactionId" },
        { "property": "bookingDate" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "amount" },
        { "property": "paymentId" },
        { "property": "hourOfEvent" },
        { "property": "agency" }
      ]
    },
    {
      "name": "metro ticket payment failed",
      "component": "CheckoutComponent",
      "stage": "Payment",
      "source": "Source.CHECKOUT_ACTIVITY",
      "description": "Metro ticket payment failed.",
      "properties": [
        { "property": "transactionId" },
        { "property": "bookingDate" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "amount" },
        { "property": "hourOfEvent" }
      ]
    },
    {
      "name": "ondc metro ticket payment successful",
      "component": "CheckoutComponent",
      "stage": "Payment",
      "source": "Source.CHECKOUT_ACTIVITY",
      "description": "ONDC metro ticket payment completed successfully.",
      "properties": [
        { "property": "transactionId" },
        { "property": "bookingDate" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "amount" },
        { "property": "paymentId" },
        { "property": "hourOfEvent" },
        { "property": "agency" }
      ]
    },
    {
      "name": "ondc metro ticket payment failed",
      "component": "CheckoutComponent",
      "stage": "Payment",
      "source": "Source.CHECKOUT_ACTIVITY",
      "description": "ONDC metro ticket payment failed.",
      "properties": [
        { "property": "transactionId" },
        { "property": "bookingDate" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "amount" },
        { "property": "hourOfEvent" }
      ]
    },
    {
      "name": "metro booking confirmed",
      "component": "ProductBookingSuccessComponent",
      "stage": "Booking Success",
      "source": "Source.PRODUCT_BOOKING_SUCCESS_FRAGMENT",
      "description": "Metro ticket booking confirmed and success screen displayed.",
      "properties": [
        { "property": "bookingId" },
        { "property": "route name" },
        { "property": "pickupStopName" },
        { "property": "dropStopName" },
        { "property": "ticketStatus" },
        { "property": "fare" },
        { "property": "passengerCount" },
        { "property": "refundInfoStatus" },
        { "property": "refundInfoMessage" }
      ],
      "notes": "sendToPlotline is true for this event."
    },
    {
      "name": "ondc metro booking confirmed",
      "component": "ProductBookingSuccessComponent",
      "stage": "Booking Success",
      "source": "Source.PRODUCT_BOOKING_SUCCESS_FRAGMENT",
      "description": "ONDC metro ticket booking confirmed and success screen displayed.",
      "properties": [
        { "property": "bookingId" },
        { "property": "route name" },
        { "property": "pickupStopName" },
        { "property": "dropStopName" },
        { "property": "ticketStatus" },
        { "property": "fare" },
        { "property": "passengerCount" },
        { "property": "refundInfoStatus" },
        { "property": "refundInfoMessage" }
      ],
      "notes": "sendToPlotline is true for this event."
    },
    {
      "name": "metro ticket fetched",
      "component": "MetroTicketValidationAnalyticManager",
      "stage": "Ticket Fetch",
      "source": "validation screen",
      "description": "Metro ticket data was fetched for validation.",
      "properties": [
        { "property": "fullName" },
        { "property": "time" },
        { "property": "date" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "orderId" },
        { "property": "activationTime" }
      ]
    },
    {
      "name": "ondc metro ticket fetched",
      "component": "OndcMetroTicketValidationAnalyticManager",
      "stage": "Ticket Fetch",
      "source": "validation screen",
      "description": "ONDC metro ticket data was fetched for validation.",
      "properties": [
        { "property": "fullName" },
        { "property": "time" },
        { "property": "date" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "orderId" },
        { "property": "activationTime" },
        { "property": "isOndcTicketOrder", "context": "true" }
      ]
    },
    {
      "name": "simple qr validation zoom qr clicked",
      "component": "MetroTicketValidationAnalyticManager",
      "stage": "QR Validation",
      "source": "validation screen",
      "description": "User clicked to zoom the QR code for easier scanning.",
      "properties": [
        { "property": "orderId" },
        { "property": "productType" },
        { "property": "productSubType" }
      ]
    },
    {
      "name": "view trip receipt from menu clicked",
      "component": "MetroTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "validation screen",
      "description": "User clicked view trip receipt from the menu.",
      "properties": [
        { "property": "fullName" },
        { "property": "time" },
        { "property": "date" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "orderId" },
        { "property": "activationTime" },
        { "property": "isOndcTicketOrder", "context": "true for ONDC metro tickets" }
      ]
    },
    {
      "name": "report problem clicked v2",
      "component": "MetroTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "validation screen",
      "description": "User clicked report problem button from validation screen.",
      "properties": [
        { "property": "type", "context": "ACTIVATION_SCREEN_TICKETING_PROBLEMS" },
        { "property": "problemSource", "context": "VALIDATION_SCREEN" },
        { "property": "fullName" },
        { "property": "time" },
        { "property": "date" },
        { "property": "productType" },
        { "property": "productSubType" },
        { "property": "orderId" },
        { "property": "activationTime" },
        { "property": "isOndcTicketOrder", "context": "true for ONDC metro tickets" }
      ]
    }
  ],
  "diagram": {
    "type": "sequence",
    "steps": [
      {
        "label": "Landing & Discovery",
        "events": [
          "stop based metro landing screen opened",
          "metro config fetch success",
          "metro all stations fetch success",
          "metro stop selected",
          "metro fare fetch success",
          "booking mode proceed button clicked"
        ],
        "next": "Confirm Booking"
      },
      {
        "label": "Confirm Booking",
        "events": [
          "confirm screen opened",
          "confirm final fare fetch success",
          "pay button clicked",
          "order api success"
        ],
        "next": "Payment"
      },
      {
        "label": "Payment",
        "events": [
          "metro ticket payment successful"
        ],
        "next": "Booking Success"
      },
      {
        "label": "Booking Success",
        "events": [
          "metro booking confirmed"
        ],
        "next": "Validation"
      },
      {
        "label": "Validation",
        "events": [
          "metro ticket fetched",
          "simple qr validation zoom qr clicked",
          "report problem clicked v2"
        ]
      }
    ],
    "notes": "ONDC metro uses additional non-prefixed events (e.g., route search result events). Static QR validation currently emits only a small subset of events for metro configs."
  }
}
