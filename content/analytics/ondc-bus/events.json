{
  "flowId": "ondc_bus",
  "flowName": "ONDC Bus Ticket Booking & Validation",
  "description": "Complete analytics map for ONDC bus ticket purchase journey from route search to validation and receipt.",
  "propertyDefinitions": {
    "isOndcTicketOrder": {
      "type": "boolean",
      "description": "Hard-coded `true` for every event in this flow to allow dashboards to filter the ONDC bus event family."
    },
    "flowType": {
      "type": "string",
      "description": "Flow type identifier (route selection uses StopBasedRouteSelectionFlowType.ONDC.toString(); fare details uses FareDetailsScreenType.ONDCTicket.eventAttributeName)."
    },
    "totalResults": {
      "type": "number",
      "description": "Total number of route search results returned for the selected stops."
    },
    "type": {
      "type": "string",
      "description": "Type of error or failure category (also used for report-problem type)."
    },
    "reason": {
      "type": "string",
      "description": "Human-readable failure description when operations fail."
    },
    "invalidResponse": {
      "type": "boolean",
      "description": "True when the fare response payload is considered invalid."
    },
    "amount": {
      "type": "string",
      "description": "Ticket fare amount (stringified)."
    },
    "bookingId": {
      "type": "string",
      "description": "Unique booking identifier for the ONDC ticket."
    },
    "route name": {
      "type": "string",
      "description": "Route name for the booked ticket."
    },
    "pickupStopName": {
      "type": "string",
      "description": "Boarding stop name."
    },
    "dropStopName": {
      "type": "string",
      "description": "Alighting stop name."
    },
    "ticketStatus": {
      "type": "string",
      "description": "Current status of the ticket (ACTIVE, EXPIRED, USED, etc.).",
      "values": [
        "ACTIVE",
        "EXPIRED",
        "FAILED",
        "PAYMENT_FAILED",
        "PAYMENT_PROCESSING",
        "PUNCHED",
        "USED"
      ]
    },
    "fare": {
      "type": "string",
      "description": "Final fare paid for the ticket (stringified)."
    },
    "passengerCount": {
      "type": "string",
      "description": "Number of passengers for this booking (stringified)."
    },
    "refundInfoStatus": {
      "type": "string",
      "description": "Refund eligibility status for the booking."
    },
    "refundInfoMessage": {
      "type": "string",
      "description": "Refund policy message displayed to user."
    },
    "paymentId": {
      "type": "string",
      "description": "Payment transaction identifier from payment gateway."
    },
    "hourOfEvent": {
      "type": "string",
      "description": "Hour of the day when the event occurred (0-23)."
    },
    "agency": {
      "type": "string",
      "description": "Transit agency name providing the ONDC bus service."
    },
    "orderId": {
      "type": "string",
      "description": "Backend order identifier for the ONDC ticket."
    },
    "chaloOrderId": {
      "type": "string",
      "description": "Chalo-specific order id mirroring the backend order."
    },
    "transaction id": {
      "type": "string",
      "description": "Transaction identifier for payment processing."
    },
    "transactionId": {
      "type": "string",
      "description": "Checkout transaction id."
    },
    "bookingDate": {
      "type": "string",
      "description": "Booking date string passed into checkout analytics."
    },
    "historyCallRetryCount": {
      "type": "number",
      "description": "Number of retry attempts for fetching ticket details post-payment."
    },
    "fullName": {
      "type": "string",
      "description": "Passenger full name associated with the ticket."
    },
    "time": {
      "type": "string",
      "description": "Time of the event in HH:mm format."
    },
    "date": {
      "type": "string",
      "description": "Date of the event in formatted string."
    },
    "productType": {
      "type": "string",
      "description": "Product type; these events always log the ONDC ticket product type constant."
    },
    "productSubType": {
      "type": "string",
      "description": "Product sub-type identifier for ONDC tickets."
    },
    "activationTime": {
      "type": "number",
      "description": "Epoch milliseconds when the ticket was activated."
    },
    "selectedSeatCount": {
      "type": "number",
      "description": "Selected seat count (when available)."
    },
    "selectedSeatNumbers": {
      "type": "string",
      "description": "Comma-separated seat numbers (when available)."
    },
    "productId": {
      "type": "string",
      "description": "Product identifier for receipt events."
    },
    "punchTime": {
      "type": "string",
      "description": "Timestamp when the ticket was punched/validated."
    },
    "vehicleNo": {
      "type": "string",
      "description": "Vehicle number where validation occurred."
    },
    "startStop": {
      "type": "string",
      "description": "Starting stop name from receipt data."
    },
    "endStop": {
      "type": "string",
      "description": "Ending stop name from receipt data."
    },
    "conductorId": {
      "type": "string",
      "description": "Conductor identifier who validated the ticket."
    },
    "endStopId": {
      "type": "string",
      "description": "Ending stop identifier from receipt."
    },
    "route id": {
      "type": "string",
      "description": "Route identifier for selected route."
    },
    "from stop id": {
      "type": "string",
      "description": "Origin stop id for route selection."
    },
    "to stop id": {
      "type": "string",
      "description": "Destination stop id for route selection."
    },
    "payload": {
      "type": "string",
      "description": "Raw receipt payload string for ONDC punch events."
    },
    "problemSource": {
      "type": "string",
      "description": "Source screen from which problem was reported."
    }
  },
  "stages": [
    {
      "name": "Route Search",
      "description": "User searches for routes between origin and destination stops for ONDC bus booking.",
      "events": [
        "stop based stop selection screen route result success",
        "stop based stop selection screen route result failure",
        "stop based stop selection screen route result item click"
      ]
    },
    {
      "name": "Fare Details",
      "description": "User views fare details, breakup, and proceeds to payment for ONDC ticket.",
      "events": [
        "find my ticket fare fare details screen opened",
        "fare details final amount bottomsheet continue click",
        "fare details final amount bottomsheet tnc clicked",
        "find my ticket fare fare details pay button clicked",
        "ondc ticket fare fetch failure"
      ]
    },
    {
      "name": "Payment",
      "description": "User completes payment for ONDC ticket through checkout flow.",
      "events": [
        "ondc ticket payment successful",
        "ondc ticket payment failed",
        "post payment history call use case failure"
      ]
    },
    {
      "name": "Booking Success",
      "description": "Booking confirmation screen after successful payment and ticket generation.",
      "events": [
        "ondc booking confirmed"
      ]
    },
    {
      "name": "Ticket Display",
      "description": "User views the active ONDC ticket with validation options.",
      "events": [
        "ondc ticket fetched"
      ]
    },
    {
      "name": "Validation - QR",
      "description": "QR code based validation flow for ONDC tickets.",
      "events": [
        "simple qr validation zoom qr clicked"
      ]
    },
    {
      "name": "Receipt & Punch",
      "description": "Trip receipt display and punch event tracking.",
      "events": [
        "ondc ticket receipt payload",
        "ondc ticket trip punched",
        "ondc ticket view receipt clicked",
        "view trip receipt from menu clicked"
      ]
    },
    {
      "name": "Global",
      "description": "Events that can fire from multiple places throughout the flow.",
      "events": [
        "report problem clicked v2"
      ]
    }
  ],
  "events": [
    {
      "name": "stop based stop selection screen route result success",
      "component": "StopBasedRouteSearchForProductPurchaseComponent",
      "stage": "Route Search",
      "source": "Source.STOP_BASED_ROUTE_SELECTION_FRAGMENT",
      "description": "Route search succeeded for ONDC bus booking between selected stops (includes 0-results case).",
      "properties": [
        {
          "property": "totalResults",
          "context": "Number of routes found"
        },
        {
          "property": "flowType",
          "context": "StopBasedRouteSelectionFlowType.ONDC.toString()"
        }
      ]
    },
    {
      "name": "stop based stop selection screen route result failure",
      "component": "StopBasedRouteSearchForProductPurchaseComponent",
      "stage": "Route Search",
      "source": "Source.STOP_BASED_ROUTE_SELECTION_FRAGMENT",
      "description": "Route search failed for ONDC bus booking.",
      "properties": [
        {
          "property": "flowType",
          "context": "StopBasedRouteSelectionFlowType.ONDC.toString()"
        }
      ]
    },
    {
      "name": "stop based stop selection screen route result item click",
      "component": "StopBasedRouteSearchForProductPurchaseComponent",
      "stage": "Route Search",
      "source": "Source.STOP_BASED_ROUTE_SELECTION_FRAGMENT",
      "description": "User selected a route from the ONDC route results list.",
      "properties": [
        {
          "property": "route id"
        },
        {
          "property": "from stop id"
        },
        {
          "property": "to stop id"
        },
        {
          "property": "flowType",
          "context": "StopBasedRouteSelectionFlowType.ONDC.toString()"
        }
      ]
    },
    {
      "name": "find my ticket fare fare details screen opened",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "Source.INSTANT_TICKET_FARE_DETAILS_FRAGMENT",
      "description": "Fare details screen opened showing ONDC ticket fare breakdown and passenger details.",
      "properties": [
        {
          "property": "amount",
          "context": "Total fare amount"
        },
        {
          "property": "flowType",
          "context": "FareDetailsScreenType.ONDCTicket.eventAttributeName (ondcTicket)"
        },
        {
          "property": "selectedSeatCount"
        },
        {
          "property": "selectedSeatNumbers"
        }
      ]
    },
    {
      "name": "fare details final amount bottomsheet continue click",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "Source.INSTANT_TICKET_FARE_DETAILS_FRAGMENT",
      "description": "User clicked continue on the final fare amount bottom sheet.",
      "properties": [
        {
          "property": "amount",
          "context": "Final fare amount"
        },
        {
          "property": "flowType",
          "context": "FareDetailsScreenType.ONDCTicket.eventAttributeName (ondcTicket)"
        }
      ]
    },
    {
      "name": "fare details final amount bottomsheet tnc clicked",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "Source.INSTANT_TICKET_FARE_DETAILS_FRAGMENT",
      "description": "User clicked on Terms & Conditions link from fare details screen.",
      "properties": [
        {
          "property": "flowType",
          "context": "FareDetailsScreenType.ONDCTicket.eventAttributeName (ondcTicket)"
        }
      ]
    },
    {
      "name": "find my ticket fare fare details pay button clicked",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "Source.INSTANT_TICKET_FARE_DETAILS_FRAGMENT",
      "description": "User clicked the pay button on fare details screen to proceed to checkout.",
      "properties": [
        {
          "property": "amount",
          "context": "Total fare amount"
        },
        {
          "property": "flowType",
          "context": "FareDetailsScreenType.ONDCTicket.eventAttributeName (ondcTicket)"
        }
      ],
      "notes": "Includes passenger-count properties keyed by passenger type id."
    },
    {
      "name": "ondc ticket fare fetch failure",
      "component": "FetchMobileTicketFareUseCase",
      "stage": "Fare Details",
      "source": "Source.FARE_DETAILS_FETCH_USECASE",
      "description": "ONDC ticket fare fetch failed due to an exception during fare fetch.",
      "properties": [
        {
          "property": "type",
          "context": "Error type category"
        },
        {
          "property": "reason",
          "context": "Failure reason message"
        },
        {
          "property": "invalidResponse",
          "context": "Raw invalid response for debugging"
        }
      ]
    },
    {
      "name": "ondc ticket payment successful",
      "component": "CheckoutAnalyticsHelper",
      "stage": "Payment",
      "source": "Source.ONDC_FARE_DETAILS_SCREEN",
      "description": "Payment completed successfully for ONDC bus ticket.",
      "properties": [
        {
          "property": "transactionId",
          "context": "Checkout transaction id"
        },
        {
          "property": "bookingDate",
          "context": "Booking date passed into checkout"
        },
        {
          "property": "productType"
        },
        {
          "property": "productSubType"
        },
        {
          "property": "amount",
          "context": "Order amount"
        },
        {
          "property": "paymentId",
          "context": "Payment transaction ID"
        },
        {
          "property": "hourOfEvent",
          "context": "Hour of day when payment succeeded"
        },
        {
          "property": "agency",
          "context": "Transit agency name"
        }
      ]
    },
    {
      "name": "ondc ticket payment failed",
      "component": "CheckoutAnalyticsHelper",
      "stage": "Payment",
      "source": "Source.ONDC_FARE_DETAILS_SCREEN",
      "description": "Payment failed for ONDC bus ticket.",
      "properties": [
        {
          "property": "transactionId",
          "context": "Checkout transaction id"
        },
        {
          "property": "bookingDate",
          "context": "Booking date passed into checkout"
        },
        {
          "property": "productType"
        },
        {
          "property": "productSubType"
        },
        {
          "property": "amount",
          "context": "Order amount"
        },
        {
          "property": "hourOfEvent",
          "context": "Hour of day when payment failed"
        },
        {
          "property": "reason",
          "context": "Payment failure reason"
        }
      ]
    },
    {
      "name": "post payment history call use case failure",
      "component": "CheckoutPostPaymentComponent",
      "stage": "Payment",
      "source": "Source.ONDC_FARE_DETAILS_SCREEN",
      "description": "Failed to fetch ticket details after payment completion.",
      "properties": [
        {
          "property": "reason",
          "context": "Failure reason"
        },
        {
          "property": "transaction id",
          "context": "Transaction ID"
        },
        {
          "property": "historyCallRetryCount",
          "context": "Number of retry attempts"
        }
      ]
    },
    {
      "name": "ondc booking confirmed",
      "component": "ProductBookingSuccessComponent",
      "stage": "Booking Success",
      "source": "Source.PRODUCT_BOOKING_SUCCESS_FRAGMENT",
      "description": "ONDC bus ticket booking confirmed and ticket generated successfully.",
      "properties": [
        {
          "property": "bookingId",
          "context": "Unique booking identifier"
        },
        {
          "property": "route name",
          "context": "Route name"
        },
        {
          "property": "pickupStopName",
          "context": "Boarding stop"
        },
        {
          "property": "dropStopName",
          "context": "Alighting stop"
        },
        {
          "property": "ticketStatus",
          "context": "Ticket status"
        },
        {
          "property": "fare",
          "context": "Final fare paid"
        },
        {
          "property": "passengerCount",
          "context": "Number of passengers"
        },
        {
          "property": "refundInfoStatus",
          "context": "Refund eligibility status"
        },
        {
          "property": "refundInfoMessage",
          "context": "Refund policy message"
        }
      ]
    },
    {
      "name": "ondc ticket fetched",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Ticket Display",
      "source": "Source.SIMPLE_QR_VALIDATION_SCREEN",
      "description": "ONDC ticket data fetched during QR validation initialization.",
      "properties": [
        {
          "property": "fullName",
          "context": "Passenger name"
        },
        {
          "property": "time",
          "context": "Event time"
        },
        {
          "property": "date",
          "context": "Event date"
        },
        {
          "property": "productType",
          "context": "Product type constant"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        },
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "activationTime",
          "context": "Activation timestamp"
        },
        {
          "property": "isOndcTicketOrder",
          "context": "true"
        }
      ]
    },
    {
      "name": "simple qr validation zoom qr clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Validation - QR",
      "source": "qr validation fragment",
      "description": "User zoomed into QR code for better scanning.",
      "properties": [
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "productType",
          "context": "Product type"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        },
        {
          "property": "isOndcTicketOrder",
          "context": "true"
        }
      ]
    },
    {
      "name": "ondc ticket receipt payload",
      "component": "OndcTicketProductValidationConfig",
      "stage": "Receipt & Punch",
      "source": "OndcTicketProductValidationConfig",
      "description": "Raw receipt payload captured from ONDC punch notification.",
      "properties": [
        {
          "property": "payload"
        }
      ]
    },
    {
      "name": "ondc ticket trip punched",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Receipt & Punch",
      "source": "qr validation fragment",
      "description": "ONDC ticket trip punched/validated by conductor with full receipt details.",
      "properties": [
        {
          "property": "productId",
          "context": "Product ID"
        },
        {
          "property": "punchTime",
          "context": "Punch timestamp"
        },
        {
          "property": "amount",
          "context": "Fare amount"
        },
        {
          "property": "vehicleNo",
          "context": "Vehicle number"
        },
        {
          "property": "route name",
          "context": "Route name"
        },
        {
          "property": "startStop",
          "context": "Start stop name"
        },
        {
          "property": "endStop",
          "context": "End stop name"
        },
        {
          "property": "conductorId",
          "context": "Conductor ID"
        },
        {
          "property": "endStopId",
          "context": "End stop ID"
        },
        {
          "property": "isOndcTicketOrder",
          "context": "true"
        }
      ]
    },
    {
      "name": "ondc ticket view receipt clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Receipt & Punch",
      "source": "qr validation fragment",
      "description": "User clicked to view trip receipt for ONDC ticket.",
      "properties": [
        {
          "property": "productId",
          "context": "Product ID"
        },
        {
          "property": "punchTime",
          "context": "Punch timestamp"
        },
        {
          "property": "amount",
          "context": "Fare amount"
        },
        {
          "property": "vehicleNo",
          "context": "Vehicle number"
        },
        {
          "property": "route name",
          "context": "Route name"
        },
        {
          "property": "startStop",
          "context": "Start stop name"
        },
        {
          "property": "endStop",
          "context": "End stop name"
        },
        {
          "property": "conductorId",
          "context": "Conductor ID"
        },
        {
          "property": "endStopId",
          "context": "End stop ID"
        },
        {
          "property": "isOndcTicketOrder",
          "context": "true"
        }
      ]
    },
    {
      "name": "view trip receipt from menu clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Receipt & Punch",
      "source": "AnalyticsEventConstants.SOURCE_VALIDATION_SCREEN",
      "description": "User clicked to view trip receipt from the menu on validation screen.",
      "properties": [
        {
          "property": "fullName",
          "context": "Passenger name"
        },
        {
          "property": "time",
          "context": "Event time"
        },
        {
          "property": "date",
          "context": "Event date"
        },
        {
          "property": "productType"
        },
        {
          "property": "productSubType"
        },
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "activationTime"
        },
        {
          "property": "isOndcTicketOrder",
          "context": "true"
        }
      ]
    },
    {
      "name": "report problem clicked v2",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "",
      "description": "User clicked report problem from validation screen.",
      "properties": [
        {
          "property": "type",
          "context": "Category of problem"
        },
        {
          "property": "problemSource",
          "context": "Source screen identifier"
        },
        {
          "property": "fullName",
          "context": "Passenger name"
        },
        {
          "property": "time",
          "context": "Event time"
        },
        {
          "property": "date",
          "context": "Event date"
        },
        {
          "property": "productType"
        },
        {
          "property": "productSubType"
        },
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "activationTime"
        },
        {
          "property": "isOndcTicketOrder",
          "context": "true"
        }
      ]
    }
  ],
  "diagram": {
    "type": "sequence",
    "steps": [
      {
        "label": "Route Search",
        "events": [
          "stop based stop selection screen route result success",
          "stop based stop selection screen route result failure",
          "stop based stop selection screen route result item click"
        ],
        "next": "Fare Details"
      },
      {
        "label": "Fare Details & Booking",
        "events": [
          "find my ticket fare fare details screen opened",
          "find my ticket fare fare details pay button clicked",
          "fare details final amount bottomsheet continue click"
        ],
        "next": "Payment"
      },
      {
        "label": "Payment & Booking Success",
        "events": [
          "ondc ticket payment successful",
          "ondc ticket payment failed",
          "ondc booking confirmed"
        ],
        "next": "Ticket Display"
      },
      {
        "label": "Ticket Display & QR Validation",
        "events": [
          "ondc ticket fetched",
          "simple qr validation zoom qr clicked"
        ],
        "next": "Receipt"
      },
      {
        "label": "Receipt & Punch",
        "events": [
          "ondc ticket receipt payload",
          "ondc ticket trip punched",
          "ondc ticket view receipt clicked"
        ]
      }
    ],
    "notes": "ONDC bus tickets use QR-based validation only. Conductor scans QR code and ticket punch receipt is delivered via push notification. Report-problem events can fire from the validation screen."
  }
}
