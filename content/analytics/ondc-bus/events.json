{
  "flowId": "ondc_bus",
  "flowName": "ONDC Bus Ticket Booking & Validation",
  "description": "Complete analytics map for ONDC bus ticket purchase journey from route search to validation and receipt.",
  "propertyDefinitions": {
    "isOndcTicketOrder": {
      "type": "boolean",
      "description": "Hard-coded `true` for every event in this flow to allow dashboards to filter the ONDC bus event family."
    },
    "flowType": {
      "type": "string",
      "description": "Flow type identifier; these events always log `ONDC` for ONDC bus tickets.",
      "values": ["ONDC"]
    },
    "totalResults": {
      "type": "number",
      "description": "Total number of route search results returned for the selected stops."
    },
    "type": {
      "type": "string",
      "description": "Type of error or failure category."
    },
    "reason": {
      "type": "string",
      "description": "Human-readable failure description when operations fail."
    },
    "invalidResponse": {
      "type": "string",
      "description": "Raw invalid response data for debugging fare fetch failures."
    },
    "amount": {
      "type": "number",
      "description": "Ticket fare amount before discounts."
    },
    "bookingId": {
      "type": "string",
      "description": "Unique booking identifier for the ONDC ticket."
    },
    "route name": {
      "type": "string",
      "description": "Route name for the booked ticket."
    },
    "pickupStopName": {
      "type": "string",
      "description": "Boarding stop name."
    },
    "dropStopName": {
      "type": "string",
      "description": "Alighting stop name."
    },
    "ticketStatus": {
      "type": "string",
      "description": "Current status of the ticket (ACTIVE, EXPIRED, USED, etc.)."
    },
    "fare": {
      "type": "number",
      "description": "Final fare paid for the ticket."
    },
    "passengerCount": {
      "type": "number",
      "description": "Number of passengers for this booking."
    },
    "refundInfoStatus": {
      "type": "string",
      "description": "Refund eligibility status for the booking."
    },
    "refundInfoMessage": {
      "type": "string",
      "description": "Refund policy message displayed to user."
    },
    "paymentId": {
      "type": "string",
      "description": "Payment transaction identifier from payment gateway."
    },
    "hourOfEvent": {
      "type": "string",
      "description": "Hour of the day when the event occurred (0-23)."
    },
    "agency": {
      "type": "string",
      "description": "Transit agency name providing the ONDC bus service."
    },
    "orderId": {
      "type": "string",
      "description": "Backend order identifier for the ONDC ticket."
    },
    "chaloOrderId": {
      "type": "string",
      "description": "Chalo-specific order id mirroring the backend order."
    },
    "transaction id": {
      "type": "string",
      "description": "Transaction identifier for payment processing."
    },
    "historyCallRetryCount": {
      "type": "number",
      "description": "Number of retry attempts for fetching ticket details post-payment."
    },
    "fullName": {
      "type": "string",
      "description": "Passenger full name associated with the ticket."
    },
    "time": {
      "type": "string",
      "description": "Time of the event in HH:mm format."
    },
    "date": {
      "type": "string",
      "description": "Date of the event in formatted string."
    },
    "productType": {
      "type": "string",
      "description": "Product type; these events always log the ONDC ticket product type constant."
    },
    "productSubType": {
      "type": "string",
      "description": "Product sub-type identifier for ONDC tickets."
    },
    "activationTime": {
      "type": "number",
      "description": "Epoch milliseconds when the ticket was activated."
    },
    "productId": {
      "type": "string",
      "description": "Product identifier for receipt events."
    },
    "punchTime": {
      "type": "string",
      "description": "Timestamp when the ticket was punched/validated."
    },
    "vehicleNo": {
      "type": "string",
      "description": "Vehicle number where validation occurred."
    },
    "startStop": {
      "type": "string",
      "description": "Starting stop name from receipt data."
    },
    "endStop": {
      "type": "string",
      "description": "Ending stop name from receipt data."
    },
    "conductorId": {
      "type": "string",
      "description": "Conductor identifier who validated the ticket."
    },
    "endStopId": {
      "type": "string",
      "description": "Ending stop identifier from receipt."
    },
    "problemType": {
      "type": "string",
      "description": "Category of problem reported."
    },
    "problemSource": {
      "type": "string",
      "description": "Source screen from which problem was reported."
    }
  },
  "stages": [
    {
      "name": "Route Search",
      "description": "User searches for routes between origin and destination stops for ONDC bus booking.",
      "events": [
        "stop based stop selection screen route result success",
        "stop based stop selection screen route result failure"
      ]
    },
    {
      "name": "Fare Details",
      "description": "User views fare details, breakup, and proceeds to payment for ONDC ticket.",
      "events": [
        "find my ticket fare fare details screen opened",
        "fare details final amount bottomsheet continue click",
        "fare details final amount bottomsheet tnc clicked",
        "find my ticket fare fare details pay button clicked",
        "ondc ticket fare fetch failure"
      ]
    },
    {
      "name": "Order Creation",
      "description": "Backend creates ONDC booking and order before payment processing.",
      "events": [
        "confirm screen opened",
        "pay button clicked",
        "confirm final fare fetch success",
        "confirm final fare fetch failed",
        "order api success",
        "order api failure",
        "retry button clicked"
      ]
    },
    {
      "name": "Payment",
      "description": "User completes payment for ONDC ticket through checkout flow.",
      "events": [
        "ondc ticket payment successful",
        "ondc ticket payment failed",
        "post payment history call use case failure"
      ]
    },
    {
      "name": "Booking Success",
      "description": "Booking confirmation screen after successful payment and ticket generation.",
      "events": [
        "ondc booking confirmed"
      ]
    },
    {
      "name": "Ticket Display",
      "description": "User views the active ONDC ticket with validation options.",
      "events": [
        "ondc ticket fetched"
      ]
    },
    {
      "name": "Validation - QR",
      "description": "QR code based validation flow for ONDC tickets.",
      "events": [
        "qr screen open",
        "simple qr validation zoom qr clicked"
      ]
    },
    {
      "name": "Receipt & Punch",
      "description": "Trip receipt display and punch event tracking.",
      "events": [
        "ondc ticket trip punched",
        "ondc ticket view receipt clicked",
        "view trip receipt from menu clicked"
      ]
    },
    {
      "name": "Global",
      "description": "Events that can fire from multiple places throughout the flow.",
      "events": [
        "exit chalo pay confirmation shown",
        "exit chalo pay confirmation yes clicked",
        "exit chalo pay confirmation no clicked",
        "report problem clicked v2"
      ]
    }
  ],
  "events": [
    {
      "name": "stop based stop selection screen route result success",
      "component": "MetroLandingScreenComponent",
      "stage": "Route Search",
      "source": "stopBasedRouteSelectionFragment",
      "description": "Route search succeeded and returned results for ONDC bus booking between selected stops.",
      "properties": [
        {
          "property": "totalResults",
          "context": "Number of routes found"
        },
        {
          "property": "flowType",
          "context": "Always 'ONDC' for ONDC bus flow"
        }
      ]
    },
    {
      "name": "stop based stop selection screen route result failure",
      "component": "MetroLandingScreenComponent",
      "stage": "Route Search",
      "source": "stopBasedRouteSelectionFragment",
      "description": "Route search failed for ONDC bus booking.",
      "properties": [
        {
          "property": "flowType",
          "context": "Always 'ONDC' for ONDC bus flow"
        }
      ]
    },
    {
      "name": "find my ticket fare fare details screen opened",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "InstantTicketFareDetailsFragment",
      "description": "Fare details screen opened showing ONDC ticket fare breakdown and passenger details.",
      "properties": [
        {
          "property": "amount",
          "context": "Total fare amount"
        },
        {
          "property": "flowType",
          "context": "Always 'ONDC' for ONDC bus flow"
        }
      ]
    },
    {
      "name": "fare details final amount bottomsheet continue click",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "InstantTicketFareDetailsFragment",
      "description": "User clicked continue on the final fare amount bottom sheet.",
      "properties": [
        {
          "property": "amount",
          "context": "Final fare amount"
        },
        {
          "property": "flowType",
          "context": "Always 'ONDC' for ONDC bus flow"
        }
      ]
    },
    {
      "name": "fare details final amount bottomsheet tnc clicked",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "InstantTicketFareDetailsFragment",
      "description": "User clicked on Terms & Conditions link from fare details screen.",
      "properties": [
        {
          "property": "flowType",
          "context": "Always 'ONDC' for ONDC bus flow"
        }
      ]
    },
    {
      "name": "find my ticket fare fare details pay button clicked",
      "component": "FareDetailsComponent",
      "stage": "Fare Details",
      "source": "InstantTicketFareDetailsFragment",
      "description": "User clicked the pay button on fare details screen to proceed to checkout.",
      "properties": [
        {
          "property": "amount",
          "context": "Total fare amount"
        },
        {
          "property": "flowType",
          "context": "Always 'ONDC' for ONDC bus flow"
        }
      ]
    },
    {
      "name": "ondc ticket fare fetch failure",
      "component": "FetchMobileTicketFareUseCase",
      "stage": "Fare Details",
      "source": "fareDetailsFetchUseCase",
      "description": "ONDC ticket fare fetch failed due to API error or invalid response.",
      "properties": [
        {
          "property": "type",
          "context": "Error type category"
        },
        {
          "property": "reason",
          "context": "Failure reason message"
        },
        {
          "property": "invalidResponse",
          "context": "Raw invalid response for debugging"
        }
      ]
    },
    {
      "name": "confirm screen opened",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "Booking confirmation screen opened showing final booking details before payment.",
      "properties": []
    },
    {
      "name": "pay button clicked",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "User clicked pay button on confirmation screen to create order.",
      "properties": [
        {
          "property": "passengerCount",
          "context": "Number of passengers"
        },
        {
          "property": "fare",
          "context": "Total fare amount"
        }
      ]
    },
    {
      "name": "confirm final fare fetch success",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "Final fare fetch succeeded before order creation.",
      "properties": []
    },
    {
      "name": "confirm final fare fetch failed",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "Final fare fetch failed before order creation.",
      "properties": [
        {
          "property": "reason",
          "context": "Failure reason"
        }
      ]
    },
    {
      "name": "order api success",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "ONDC booking order created successfully via API.",
      "properties": [
        {
          "property": "orderId",
          "context": "Backend order ID"
        }
      ]
    },
    {
      "name": "order api failure",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "ONDC booking order creation failed.",
      "properties": [
        {
          "property": "reason",
          "context": "Error message"
        }
      ]
    },
    {
      "name": "retry button clicked",
      "component": "ConfirmBookingScreenComponent",
      "stage": "Order Creation",
      "source": "confirmBookingScreen",
      "description": "User clicked retry button after order creation failure.",
      "properties": []
    },
    {
      "name": "ondc ticket payment successful",
      "component": "CheckoutAnalyticsHelper",
      "stage": "Payment",
      "source": "Product-specific source",
      "description": "Payment completed successfully for ONDC bus ticket.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "paymentId",
          "context": "Payment transaction ID"
        },
        {
          "property": "hourOfEvent",
          "context": "Hour of day when payment succeeded"
        },
        {
          "property": "agency",
          "context": "Transit agency name"
        }
      ]
    },
    {
      "name": "ondc ticket payment failed",
      "component": "CheckoutAnalyticsHelper",
      "stage": "Payment",
      "source": "Product-specific source",
      "description": "Payment failed for ONDC bus ticket.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "hourOfEvent",
          "context": "Hour of day when payment failed"
        },
        {
          "property": "reason",
          "context": "Payment failure reason"
        }
      ]
    },
    {
      "name": "post payment history call use case failure",
      "component": "CheckoutPostPaymentComponent",
      "stage": "Payment",
      "source": "postPaymentScreen",
      "description": "Failed to fetch ticket details after payment completion.",
      "properties": [
        {
          "property": "reason",
          "context": "Failure reason"
        },
        {
          "property": "transaction id",
          "context": "Transaction ID"
        },
        {
          "property": "historyCallRetryCount",
          "context": "Number of retry attempts"
        }
      ]
    },
    {
      "name": "ondc booking confirmed",
      "component": "ProductBookingSuccessComponent",
      "stage": "Booking Success",
      "source": "ProductBookingSuccessFragment",
      "description": "ONDC bus ticket booking confirmed and ticket generated successfully.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "bookingId",
          "context": "Unique booking identifier"
        },
        {
          "property": "route name",
          "context": "Route name"
        },
        {
          "property": "pickupStopName",
          "context": "Boarding stop"
        },
        {
          "property": "dropStopName",
          "context": "Alighting stop"
        },
        {
          "property": "ticketStatus",
          "context": "Ticket status"
        },
        {
          "property": "fare",
          "context": "Final fare paid"
        },
        {
          "property": "passengerCount",
          "context": "Number of passengers"
        },
        {
          "property": "refundInfoStatus",
          "context": "Refund eligibility status"
        },
        {
          "property": "refundInfoMessage",
          "context": "Refund policy message"
        }
      ]
    },
    {
      "name": "ondc ticket fetched",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Ticket Display",
      "source": "Various sources",
      "description": "ONDC ticket data fetched and displayed to user for validation.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "fullName",
          "context": "Passenger name"
        },
        {
          "property": "time",
          "context": "Event time"
        },
        {
          "property": "date",
          "context": "Event date"
        },
        {
          "property": "productType",
          "context": "Product type constant"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        },
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "activationTime",
          "context": "Activation timestamp"
        }
      ]
    },
    {
      "name": "qr screen open",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Validation - QR",
      "source": "Various sources",
      "description": "QR validation screen opened for ONDC ticket.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "productType",
          "context": "Product type"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        }
      ]
    },
    {
      "name": "simple qr validation zoom qr clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Validation - QR",
      "source": "Various sources",
      "description": "User zoomed into QR code for better scanning.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "productType",
          "context": "Product type"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        }
      ]
    },
    {
      "name": "ondc ticket trip punched",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Receipt & Punch",
      "source": "Various sources",
      "description": "ONDC ticket trip punched/validated by conductor with full receipt details.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "productId",
          "context": "Product ID"
        },
        {
          "property": "punchTime",
          "context": "Punch timestamp"
        },
        {
          "property": "amount",
          "context": "Fare amount"
        },
        {
          "property": "vehicleNo",
          "context": "Vehicle number"
        },
        {
          "property": "route name",
          "context": "Route name"
        },
        {
          "property": "startStop",
          "context": "Start stop name"
        },
        {
          "property": "endStop",
          "context": "End stop name"
        },
        {
          "property": "conductorId",
          "context": "Conductor ID"
        },
        {
          "property": "endStopId",
          "context": "End stop ID"
        }
      ]
    },
    {
      "name": "ondc ticket view receipt clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Receipt & Punch",
      "source": "Various sources",
      "description": "User clicked to view trip receipt for ONDC ticket.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "productId",
          "context": "Product ID"
        },
        {
          "property": "punchTime",
          "context": "Punch timestamp"
        },
        {
          "property": "amount",
          "context": "Fare amount"
        },
        {
          "property": "vehicleNo",
          "context": "Vehicle number"
        },
        {
          "property": "route name",
          "context": "Route name"
        },
        {
          "property": "startStop",
          "context": "Start stop name"
        },
        {
          "property": "endStop",
          "context": "End stop name"
        },
        {
          "property": "conductorId",
          "context": "Conductor ID"
        },
        {
          "property": "endStopId",
          "context": "End stop ID"
        }
      ]
    },
    {
      "name": "view trip receipt from menu clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Receipt & Punch",
      "source": "SOURCE_VALIDATION_SCREEN",
      "description": "User clicked to view trip receipt from the menu on validation screen.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "productType",
          "context": "Product type"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        }
      ]
    },
    {
      "name": "exit chalo pay confirmation shown",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "Various sources",
      "description": "Confirmation dialog shown when user pressed back button during validation.",
      "properties": []
    },
    {
      "name": "exit chalo pay confirmation yes clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "Various sources",
      "description": "User confirmed back navigation from validation screen.",
      "properties": []
    },
    {
      "name": "exit chalo pay confirmation no clicked",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "Various sources",
      "description": "User cancelled back navigation and stayed on validation screen.",
      "properties": []
    },
    {
      "name": "report problem clicked v2",
      "component": "OndcTicketValidationAnalyticManager",
      "stage": "Global",
      "source": "SOURCE_VALIDATION_SCREEN",
      "description": "User clicked report problem from validation screen.",
      "autoProperties": [
        "isOndcTicketOrder"
      ],
      "properties": [
        {
          "property": "problemType",
          "context": "Category of problem"
        },
        {
          "property": "problemSource",
          "context": "Source screen identifier"
        },
        {
          "property": "orderId",
          "context": "Order ID"
        },
        {
          "property": "productType",
          "context": "Product type"
        },
        {
          "property": "productSubType",
          "context": "Product sub-type"
        }
      ]
    }
  ],
  "diagram": {
    "type": "sequence",
    "steps": [
      {
        "label": "Route Search",
        "events": [
          "stop based stop selection screen route result success",
          "stop based stop selection screen route result failure"
        ],
        "next": "Fare Details"
      },
      {
        "label": "Fare Details & Order Creation",
        "events": [
          "find my ticket fare fare details screen opened",
          "find my ticket fare fare details pay button clicked",
          "order api success",
          "order api failure"
        ],
        "next": "Payment"
      },
      {
        "label": "Payment & Booking Success",
        "events": [
          "ondc ticket payment successful",
          "ondc ticket payment failed",
          "ondc booking confirmed"
        ],
        "next": "Ticket Display"
      },
      {
        "label": "Ticket Display & QR Validation",
        "events": [
          "ondc ticket fetched",
          "qr screen open",
          "simple qr validation zoom qr clicked"
        ],
        "next": "Receipt"
      },
      {
        "label": "Receipt & Punch",
        "events": [
          "ondc ticket trip punched",
          "ondc ticket view receipt clicked"
        ]
      }
    ],
    "notes": "ONDC bus tickets use QR-based validation only. Conductor scans QR code and ticket punch receipt is delivered via push notification. Global events (report problem, back press confirmation) can fire from multiple locations throughout the flow."
  }
}
